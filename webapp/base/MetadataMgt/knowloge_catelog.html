<!DOCTYPE html>
<html lang="zh-cmn-Hans" xmlns:v-on="http://www.w3.org/1999/xhtml"
      xmlns:v-bind="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1.0, user-scalable=no"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <title>课标管理</title>

    <script src="../../common/js/base.js"></script>
    <script src="../../common/js/jquery/jquery-2.1.4.min.js"></script>
    <script src="../../common/js/lhgdialog/lhgdialog.min.js?skin=alEngin"></script>

    <link rel="stylesheet" href="../../common/js/MDUI/css/mdui.min.css">
    <link rel="stylesheet" href="../../common/js/MDUI/css/doc.css">

    <link href="../../common/js/zTree_v3/css/zTreeStyle/zTreeStyle.css" rel="stylesheet" type="text/css" />
    <script src="../../common/js/zTree_v3/js/jquery.ztree.core.min.js"></script>
    <script src="../../common/js/zTree_v3/js/jquery.ztree.excheck.min.js"></script>

    <link href="../../common/js/jquery/jquery-ui/jquery-ui.css" rel="stylesheet" type="text/css" />
    <script src="../../common/js/jquery/jquery-ui/jquery-ui.js"></script>

 <style>
    .color-palette {
        position: relative;
        padding: 0 0 36px 0;
        margin: 0;
        list-style: none;
        font-weight: 500;
        font-size: 14px;
    }
    .color-palette li {
        padding: 15px;
    }
    .color-palette .color-divider {
        margin-top: 8px;
    }
    .color-palette .main-color {
    }
    .color-palette .main-color .color-name {
        display: block;
        margin-bottom: 60px;
    }
    .color-palette .color-hex {
        float: right;
        text-transform: uppercase;
    }
    .color-palette .anchor-primary-color {
        position: absolute;
        top: -72px;
    }
    .color-palette .anchor-accent-color {
        position: absolute;
        top: 520px;
    }
    #versionTree{
    text-decoration: none;
    list-style: none;
    padding: 0;}
    
    #versionTree li{
     float: left;
     margin: 8px;
     cursor: pointer;
     
     }
</style>

</head>
<body class="mdui-drawer-body-left mdui-appbar-with-toolbar  mdui-theme-primary-indigo mdui-theme-accent-pink">
<header class="mdui-appbar mdui-appbar-fixed">
    <div id="head"></div>
</header>

<div id="leftMenu"></div>

<a id="anchor-top"></a>

<div id="baseBookCatelog" class="mdui-container doc-container doc-no-cover" style="margin-top: -40px;">
    <h1 class="doc-title mdui-text-color-theme">课标管理
        <button class="mdui-btn mdui-btn-dense mdui-btn-raised mdui-ripple mdui-color-blue-accent"
                v-on:click="setPropertyRedis()">
                        加载缓存
        </button>
    </h1>

    <div class="mdui-row" >
        <div class="mdui-col-xs-2">
            <div>
               <ul class="mdui-list" v-for="(baseSubject,index) in baseSubjectList">
               <li class="mdui-list-item mdui-ripple"
                    v-on:click="listBaseSubjectItemChecked(index,baseSubject)"
                    v-bind:class="{'mdui-list-item-active':index==subjectActive}"
                    v-bind:title="baseSubject.propertyValue">{{baseSubject.propertyValue}}</li>
			  </ul>
            </div>
        </div>

        <div class="mdui-col-xs-10">
	         <div class="mdui-card" style="padding-bottom: 20px;">
		         <div class="mdui-row mdui-valign" style="background: #e9ebec;">
		           <div class="mdui-col-sm-4">
		               <div class="mdui-card-primary">
		                  <div class="mdui-card-primary-title">{{baseSubject.propertyValue}}</div>
		               </div>
                  </div>
              </div>
                <!-- 卡片的内容 -->
                <div class="mdui-card-content">
                 <div class="mdui-row">
					<div class="mdui-col-sm-4">
		                <table style="width:100%">
		                    <tr>
		                        <td valign="top" style="width:200px;">
		                            <div id="treeDiv" class="ztree">
		                            </div>
		                        </td>
		                    </tr>
		                </table>
            		</div>
					<div class="mdui-col-sm-8">
					<div class="mdui-row" >
		               <button class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme-accent" mdui-dialog="{target: '#orderBaseBookCatelogList'}">排序</button>
		               <button class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme-accent" v-on:click="deleteBookCateLogRow()">删除</button>
		               <button class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme-accent" v-on:click="addOrEditBaseBookCatelog(true)">新增</button>
		             </div>
		               <div class="mdui-row" style="margin-top: 10px">
                          <div class="mdui-table-fluid">
							  <table class="mdui-table mdui-table-hoverable">
							    <thead>
							      <tr>
							        <th>选择</th>
							        <th>序号</th>
							        <th >名称</th>
							        <th >节点类型</th>
							        <th>代码</th>
							        <th>操作</th>
							      </tr>
							    </thead>
							    <tbody>
							      <tr class="mdui-table-selectable" v-for="(baseCatelog,index) in baseBookCateList" v-bind:code="baseCatelog.code">
							        <td>
							          <label v-on:click="baseCatelogSelectRowClick(baseCatelog,index)" class="mdui-checkbox"><input type="checkbox" v-bind:checked="baseBookCateSelectRowIndex==index"><i class="mdui-checkbox-icon" ></i></label>
							        </td>
							        <td>{{index+1}}</td>
							        <td>{{baseCatelog.name}}</td>
							        <td>{{baseCatelog.nodeType==0?'叶子节点':'非叶子节点'}}</td>
							        <td>{{baseCatelog.code}}</td>
							        <td>
							            <button class="mdui-btn mdui-btn-icon mdui-btn-dense mdui-btn-raised mdui-color-theme-accent mdui-ripple" v-on:click="addOrEditBaseBookCatelog(false)" title="修改" >
					                        <i class="mdui-icon material-icons">edit</i>
					                    </button>
					                    <button v-if="baseCatelog.status==0" class="mdui-btn mdui-btn-icon mdui-btn-dense mdui-btn-raised mdui-color-theme-accent mdui-ripple"  v-on:click="stopOrStartBookCatelog(false)" title="停用教材">
				                            <i class="mdui-icon material-icons">stop</i>
				                        </button>
					                    <button v-else class="mdui-btn mdui-btn-icon mdui-btn-dense mdui-btn-raised mdui-color-theme-accent mdui-ripple"  v-on:click="stopOrStartBookCatelog(true)" title="启用教材">
					                        <i class="mdui-icon material-icons">play_arrow</i>
					                    </button>
							        </td>
							      </tr>
							    </tbody>
							  </table>
							</div>
                       </div>
                    </div>
                  </div>
				</div>   
		    </div>
     </div>
    
    <div>
		<!--弹出框 添加教材-->
         <div class="mdui-dialog" id="dialogAddBaseBookCatelog">
            <div class="mdui-dialog-title">课标管理</div>
            <div class="mdui-dialog-content" >
            
                <div class="mdui-textfield "  v-bind:class="checkedNode.code==''?'mdui-textfield-invalid':''">
                    <label class="mdui-textfield-label">父课标编码</label>
                    <input class="mdui-textfield-input" placeholder="父课标编码" v-model="checkedNode.code" disabled="disabled" required/>
                </div>
                <div class="mdui-textfield " v-bind:class="checkedNode.name==''?'mdui-textfield-invalid':''">
                    <label class="mdui-textfield-label">父课标名称</label>
                    <input class="mdui-textfield-input" placeholder="父课标名称" v-model="checkedNode.name" disabled="disabled" required/>
                </div>
                <div class="mdui-textfield " v-bind:class="baseCatelogSelectedRow.code==''?'mdui-textfield-invalid':''">
                    <label class="mdui-textfield-label">课标编码</label>
                    <input class="mdui-textfield-input" placeholder="教材编码" v-model="baseCatelogSelectedRow.code" required/>
                    <div class="mdui-textfield-error">课标编码不能为空</div>
                </div>
                <div class="mdui-textfield " v-bind:class="baseCatelogSelectedRow.name==''?'mdui-textfield-invalid':''">
                    <label class="mdui-textfield-label">课标名称</label>
                    <input class="mdui-textfield-input" placeholder="教材名称" v-model="baseCatelogSelectedRow.name" required/>
                    <div class="mdui-textfield-error">课标名称不能为空</div>
                </div>
                 <div>
                    <label class="mdui-textfield-label">节点类型</label>
                    <select id="nodeTypeSelect" class="mdui-select" mdui-select="{position: 'top'}" v-model="baseCatelogSelectedRow.nodeType">
                        <option value="0">叶子节点</option>
                        <option value="1">非叶子节点</option>
                    </select>
                </div>
                 <div style="margin-top: 10px">
                    <label class="mdui-textfield-label">知识类型</label>
                    <select id="knowTypeSelect" class="mdui-select" mdui-select="{position: 'top'}" v-model="baseCatelogSelectedRow.nodeType">
                        <option value="0" >课程标准</option>
                        <option value="1" >知识点</option>
                    </select>
                </div>
            </div>
            <div class="mdui-dialog-actions">
                <button class="mdui-btn mdui-ripple" mdui-dialog-close>取消</button>
                <button class="mdui-btn mdui-ripple" mdui-dialog-confirm v-on:click="operateSaveBaseBookCatelog()">确定</button>
            </div>
        </div>

      <!--弹出框  删除教材 -->
	   <div class="mdui-dialog" id="dialogDeleteCatelog">
	    <div class="mdui-dialog-title">确认删除？</div>
	    <div class="mdui-dialog-content">您确定要删除教材目录 [ {{baseCatelogSelectedRow.name}} ] 吗？</div>
	    <div class="mdui-dialog-actions">
	      <button class="mdui-btn mdui-ripple" mdui-dialog-close>取消</button>
	      <button class="mdui-btn mdui-ripple" mdui-dialog-confirm v-on:click="deleteBookCateLog()">确定</button>
	    </div>
	  </div>


      <!--弹出框 停用教材 -->
	 <div class="mdui-dialog" id="dialogStopBookCatelog">
	    <div class="mdui-dialog-title">确认停用教材？</div>
	    <div class="mdui-dialog-content">您确定要停用教材 [ {{baseCatelogSelectedRow.name}} ] 吗？</div>
	    <div class="mdui-dialog-actions">
	      <button class="mdui-btn mdui-ripple" mdui-dialog-close>取消</button>
	      <button class="mdui-btn mdui-ripple" mdui-dialog-confirm v-on:click="stopOrStartSaveBaseBookCatelog(1)">确定</button>
	    </div>
	  </div>

     <!--弹出框 启用教材 -->
	 <div class="mdui-dialog" id="dialogStartBookCatelog">
	    <div class="mdui-dialog-title">确认启用教材？</div>
	    <div class="mdui-dialog-content">您确定要启用教材 [ {{baseCatelogSelectedRow.name}} ] 吗？</div>
	    <div class="mdui-dialog-actions">
	      <button class="mdui-btn mdui-ripple" mdui-dialog-close>取消</button>
	      <button class="mdui-btn mdui-ripple" mdui-dialog-confirm v-on:click="stopOrStartSaveBaseBookCatelog(0)">确定</button>
	    </div>
	  </div>

	 <!--弹出框 调整周次-->
        <div class="mdui-dialog" id="editBaseBookCatelogZC">
            <div class="mdui-dialog-title">调整周次</div>
            <div class="mdui-dialog-content" >
				<div class="mdui-textfield">
				   <input class="mdui-textfield-input" type="text" v-model="baseCatelogSelectedRow.zhouCi"  placeholder="周次"/>
				</div>
            </div>
            <div class="mdui-dialog-actions">
                <button class="mdui-btn mdui-ripple" mdui-dialog-close>取消</button>
                <button class="mdui-btn mdui-ripple" mdui-dialog-confirm v-on:click="saveBaseBookCateLogZC()">确定</button>
            </div>
        </div>
        
        
         <!-- 给教材排序 -->
         <div class="mdui-dialog" id="orderBaseBookCatelogList">
            <div class="mdui-dialog-title">教材排序</div>
            <div class="mdui-dialog-content" >
                 <div class="mdui-row" style="margin-top: 10px;">
                 <div class="mdui-col-sm-9">
                          <div class="mdui-table-fluid" style="max-height: 330px;">
							  <table class="mdui-table mdui-table-hoverable versionSortTable" id="bookCatelogSortTable">
							   <thead>
							      <tr>
							        <th>序号</th>
							        <th>名称</th>
							        <th>排序</th>
							      </tr>
							    </thead>
							    <tbody>
							      <tr v-bind:id="baseCatelog.kcId" v-for="(baseCatelog,index) in baseBookCateList" v-bind:code="baseCatelog.code">
							        <td >{{index+1}}</td>
							        <td>{{baseCatelog.name}}</td>
							        <td><i class="mdui-icon material-icons" style="cursor: pointer;" title="按住拖动排序">sort</i></td>
							      </tr>
							    </tbody>
							  </table>
							</div>
                   </div>
                   <div class="mdui-col-sm-3" style="vertical-align: middle;">
                    <div v-show="false" class="mdui-row" style="margin-top: 10px; margin-left: 20px;">
                       <button class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme-accent" v-on:click="zIndexUp(baseBookCateList,baseBookCateSelectRowIndex,baseBookCateList.length)">向上</button>
                    </div>
                    
					<div v-show="false"  class="mdui-row" style="margin-top: 10px;margin-left: 20px;">
                       <button class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme-accent" v-on:click="zIndexDown(baseBookCateList,baseBookCateSelectRowIndex,baseBookCateList.length)">向下</button>
                    </div>
                    
                    <div class="mdui-row" style="margin-top: 10px;margin-left: 20px;">
                       <button class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme-accent" v-on:click="saveOrderedVersionList(baseSubject)">保存</button>
                    </div>
                    
                   </div>
                </div>
            </div>
            <div class="mdui-dialog-actions">
                <button class="mdui-btn mdui-ripple" mdui-dialog-close v-on:click="updateTreeNode()">取消</button>
            </div>
        </div>
</div>
</div>

<script src="../../common/js/MDUI/js/mdui.min.js"></script>
<script src="../../common/js/vue/vue.min.js"></script>

<script>
    console.log(projectName);

    var setting = {
        callback: {
            onClick: zTreeOnClick
        },
        view: {
            dblClickExpand: dblClickExpand
        },
        data: {
        	simpleData: {
                enable: true,
                pIdKey:"parentCode",
                idKey:"code",
            },
            key:{
                name:"name",
            }
        }
    };

    var zNodes = "";
    $(function(){
        //引入head
        $('#head').load('../head.html',function () {

        })
        //引入leftMenu
        $('#leftMenu').load('../leftMenu.html',function () {
            $('#admin_knowloge_catelog').addClass("mdui-list-item-active");
            $('#admin_knowloge_catelog').parents(".mdui-collapse-item").addClass("mdui-collapse-item-open");
            mdui.mutation();
        })
        
        //initSubject();
        initTree();

    });

    var vm = new Vue({
                         el:"#baseBookCatelog",
                         data : {
                             baseSubject:{
                            	 creTime: '',
                            	 creUser: '',
                            	 groupKey: '',
                            	 modTime: '',
                            	 modUser: '',
                            	 pid:'',
                            	 propertyDesc: '',
                            	 propertyKey: '',
                            	 propertyValue: '',
                            	 seqNo: null,
                            	 active:0
                             },
                             baseVersion:{
                            	 abbreviation: null,
                            	 creTime: '',
                            	 creUser: null,
                            	 modTime: null,
                            	 modUser: null,
                            	 press: null,
                            	 seqNo: null,
                            	 subjectCode: '',
                            	 versionCode: null,
                            	 versionId: '',
                            	 versionName: '',
                            	 isSelected: false,
                            	 status:0
                             },
                             baseVersionForm:{
                            	 abbreviation: null,
                            	 creTime: '',
                            	 creUser: null,
                            	 modTime: null,
                            	 modUser: null,
                            	 press: null,
                            	 seqNo: null,
                            	 subjectCode: '',
                            	 versionCode: null,
                            	 versionId: '',
                            	 versionName: '',
                             },
                             selectedSortVersionRow:{
                            	 selectedIndex:0
                             },
                             baseBookCateSelectRowIndex:-1,
                             baseCatelogSelectedRow:{},
                             baseSubjectList:[],
                             baseVersionList:[],
                             baseBookCateList:[],
                             checkedNode:{},
                             subjectActive:0,
                             active:'-1'
                         },
                         created(){
                             this.defaultBaseSubject  = JSON.parse(JSON.stringify(this.baseSubject));
                             this.defaultBaseBookVersion = JSON.parse(JSON.stringify(this.baseVersionForm));
                         },
                         // 初始化执行
                         mounted(){
                           this.initSubject()
                         },
                         //执行某些方法后数据产生了变化再执行
                         updated:function () {

                         },
                         // 数据发生变化之后进行监听，再执行
                         watch:{

                         },
                         methods : {
                        	 initSubject:function(){
                        		 $.ajax({
                                     type : "post",
                                     url : projectName + "/base/baseBookCatelog/listSubject",
                                     datatype : 'json',
                                     contentType:"application/json",
                                     success : function(data) {
                                         if(data.success == true){
                                             if(data.obj.length>0){
                                            	 vm.baseSubjectList = data.obj;
                                            	 vm.baseSubject = data.obj[0];
                                            	 vm.listBaseSubjectItemChecked(0,data.obj[0]);
                                             }else{
                                            	 vm.baseSubjectList =[];
                                            	 vm.baseSubject = {};
                                             }
                                         }else{
                                             mdui.alert(data.message);
                                         }
                                     },
                                     error : function() {
                                         $.dialog.alert('请求失败！',function(){});
                                     }
                                 });
                        	 },
                        	 listBaseSubjectItemChecked:function(index,baseSubject){
                        		 vm.baseSubject = baseSubject;
                        		 vm.subjectActive = index;
                        		 var obj={};
                        		 obj.subjectCode = baseSubject.propertyKey;
                        		 
                        		 $.ajax({
                                     type : "post",
                                     url : projectName + "/base/baseKnowledgeCatelog/listTree",
                                     datatype : 'json',
                                     data : JSON.stringify(obj),
                                     contentType:"application/json",
                                     success : function(data) {
                                         if(data.success == true){
                                        	 if(data.obj.length>0){
                                        		 zNodes = data.obj;
                                                 var treeObj =$.fn.zTree.init($("#treeDiv"), setting, zNodes);
                                                 var node = treeObj.getNodeByParam("code", "-1");
                                                 treeObj.selectNode(node);
                                                 treeObj.setting.callback.onClick(null, treeObj.setting.treeId, node);
                                        	 }
                                         }else{
                                        	 zNodes=[];
                                    		 var treeObj =$.fn.zTree.init($("#treeDiv"), setting, zNodes);
                                         }
                                     },
                                     error : function() {
                                         $.dialog.alert('请求失败！',function(){});
                                     }
                                 });
                        	 },
                        	 listBaseVersionItemChecked:function(index,baseVersion){
                        		 vm.baseVersion = baseVersion;
                        		 queryBaseTree(baseVersion);
                        	 },
                        	 listBookCatesByParentCode:function(subjectCode,parentCode){
                        		 var obj={};
                        		 obj.subjectCode = vm.baseSubject.propertyKey;
                                 obj.parentCode = parentCode;
                        		 $.ajax({
                                     type : "post",
                                     url : projectName + "/base/baseKnowledgeCatelog/listTree",
                                     data : JSON.stringify(obj),
                                     datatype : 'json',
                                     contentType:"application/json",
                                     success : function(data) {
                                    	 if(data.success == true){
                                        	 vm.baseBookCateSelectRowIndex=-1;
                                      	     vm.baseCatelogSelectedRow = {}; 
                                        	 if(data.obj.length>0){
                                                vm.baseBookCateList = data.obj;
                                        	 }else{
                                        		 vm.baseBookCateList=[];
                                        	 }
                                         }else{
                                        	 vm.baseBookCateSelectRowIndex=-1;
                                      	     vm.baseCatelogSelectedRow = {}; 
                                      	     vm.baseBookCateList=[];
                                         }
                                     },
                                     error : function() {
                                         $.dialog.alert('请求失败！',function(){});
                                     }
                                 });
                        	 },
                        	 addBaseBookVersion:function(baseVersionForm,baseSubject){
                        		 baseVersionForm.subjectCode = baseSubject.propertyKey;
                        		 var inst = new mdui.Dialog('#addBaseBookVersion');
                        		 $.ajax({
                                     type : "post",
                                     url : projectName + "/base/baseBookVersion/save",
                                     data : JSON.stringify(baseVersionForm),
                                     datatype : 'json',
                                     contentType:"application/json",
                                     success : function(data) {
                                         inst.close();
                                         if(data.success == true){
                                              vm.listBaseSubjectItemChecked(vm.subjectActive,baseSubject); 
                                         }else{
                                             mdui.alert(data.message);
                                         }
                                     },
                                     error : function() {
                                         $.dialog.alert('请求失败！',function(){});
                                     }
                                 });
                        	 },
                        	 editBaseBookVersion:function(baseVersion,baseSubject){
                        		 var inst = new mdui.Dialog('#editBaseBookVersion');
                        		 $.ajax({
                                     type : "post",
                                     url : projectName + "/base/baseBookVersion/update",
                                     data : JSON.stringify(baseVersion),
                                     datatype : 'json',
                                     contentType:"application/json",
                                     success : function(data) {
                                         inst.close();
                                         if(data.success == true){
                                              vm.listBaseSubjectItemChecked(vm.subjectActive,baseSubject); 
                                         }else{
                                             mdui.alert(data.message);
                                         }
                                     },
                                     error : function() {
                                         $.dialog.alert('请求失败！',function(){});
                                     }
                                 });
                        	 }
                        	 ,
                        	 saveOrderedVersionList:function(baseSubject){
                        		 var inst = new mdui.Dialog('#orderBaseBookCatelogList');
                        		 var allIds = $("#bookCatelogSortTable tbody").sortable('toArray');
                        		 $.ajax({
                                     type : "post",
                                     url : projectName + "/base/baseKnowledgeCatelog/saveOrderdKnowledgeCatelogList",
                                     data : JSON.stringify(allIds),
                                     datatype : 'json',
                                     contentType:"application/json",
                                     success : function(data) {
                                         inst.close();
                                    	 updateTreeNode();
                                     },
                                     error : function() {
                                         $.dialog.alert('请求失败！',function(){});
                                     }
                                 });
                        	 },
                        	 deleteVersion:function(baseVersion){
                        		 $.ajax({
                                     type : "post",
                                     url : projectName + "/base/baseBookVersion/delete",
                                     data : JSON.stringify(baseVersion),
                                     datatype : 'json',
                                     contentType:"application/json",
                                     success : function(data) {
                                         if(data.success == true){
                                             vm.listBaseSubjectItemChecked(vm.subjectActive,vm.baseSubject);
                                         }else{
                                             mdui.alert(data.message);
                                         }
                                     },
                                     error : function() {
                                         $.dialog.alert('请求失败！',function(){});
                                     }
                                 });
                        	 },
                        	 previewTree:function(){
                        		 var treeObj =$.fn.zTree.init($("#treeDivPreview"), setting, zNodes);
                                 var node = treeObj.getNodeByParam("code", "-1");
                                 treeObj.selectNode(node);
                                 treeObj.expandAll(true);
                        	 }
                         }
                     });

    // 排序
    var fixHelperModified = function(e, tr) {
            var $originals = tr.children();
            var $helper = tr.clone();
            $helper.children().each(function(index) {
                $(this).width($originals.eq(index).width())
            });
            return $helper;
        },
        updateIndex = function(e, ui) {
            $('td.index', ui.item.parent()).each(function (i) {
                $(this).html(i + 1);
            });
        };
        
       $("#sort tbody").sortable(
		   {
             handle: ".mdui-icon", //还有这个class类点中了才能拖移
             helper: fixHelperModified,
             stop: updateIndex,
             opacity: 0.6,                       //拖动时，透明度为0.6
             revert: true,
             axis:'y', // 只能y轴移动
             delay:100,// 按住100ms后才能使用，防止误触
          }).disableSelection();
     
       
       function initTree(){
    	   //queryBaseTree();
           var treeObj =$.fn.zTree.init($("#treeDiv"), setting, zNodes);
           var node = treeObj.getNodeByParam("code", "-1");
           treeObj.selectNode(node);
           treeObj.setting.callback.onClick(null, treeObj.setting.treeId, node);
       }

       function dblClickExpand(treeId, treeNode) {
           return treeNode.level > 0;
       }
       
       function zTreeOnClick(event, treeId, treeNode) {
           if(treeNode != null){
        	   vm.checkedNode = treeNode;
        	   vm.listBookCatesByParentCode(treeNode.subjectCode,treeNode.code);
           }
       }
       function queryBaseTree(obj){
           $.ajax({
                      type : "post",
                      url : projectName + "/base/baseBookCatelog/listTree",
                      data : JSON.stringify(obj),
                      datatype : 'json',
                      contentType:"application/json",
                      async: false,
                      success : function(data) {
                          zNodes = data.obj;
                          var treeObj =$.fn.zTree.init($("#treeDiv"), setting, zNodes);
                          var node = treeObj.getNodeByParam("code", "-1");
                          treeObj.selectNode(node);
                          treeObj.setting.callback.onClick(null, treeObj.setting.treeId, node);
                      },
                      error : function() {
                          $.dialog.alert('请求失败！',function(){});
                      }
                  });
       };
       
       //教材列表行点击事件
       function baseCatelogSelectRowClick(baseCatelog,index){
    	   
    	   vm.baseBookCateSelectRowIndex=index;
    	   vm.baseCatelogSelectedRow = baseCatelog; 
       }
       
       function initBaseVersionFormDialogData(){
    	   vm.baseVersionForm = Object.assign(vm.baseVersionForm,vm.defaultBaseBookVersion);
       }
       
       // ----------------------------------------排序开始---------------------------------
       
       /**
       * 数组元素交换位置
       * @param {array} arr 数组
       * @param {number} index1 添加项目的位置
       * @param {number} index2 删除项目的位置
       * index1和index2分别是两个数组的索引值，即是两个要交换元素位置的索引值，如1，5就是数组中下标为1和5的两个元素交换位置
       */
       function swapArray(arr, index1, index2) {
          arr[index1] = arr.splice(index2, 1, arr[index1])[0];
          versionSortTableRowClick(arr[index2],index2)
           return arr;
       }
       
      //上移将当前数组index索引与后面一个元素互换位置，向数组后面移动一位
       function zIndexDown(arr,index,length){
          if(index+1 != length){
              swapArray(arr, index, index+1);
          }else{
        	  alert('已经处于置底，无法下移');
         }
       }

       //下移将当前数组index索引与前面一个元素互换位置，向数组前面移动一位
       function zIndexUp(arr,index,length){
          if(index!= 0){
              swapArray(arr, index, index-1);
          }else{
            alert('已经处于置顶，无法上移');
         }
       }
       
       //数组元素移动
       function sortArray(arr,index,tindex){
       	  //如果当前元素在拖动目标位置的下方，先将当前元素从数组拿出，数组长度-1，我们直接给数组拖动目标位置的地方新增一个和当前元素值一样的元素，
       	  //我们再把数组之前的那个拖动的元素删除掉，所以要len+1
       	  if(index>tindex){
       	    arr.splice(tindex,0,arr[index]);
       	    arr.splice(index+1,1)
       	  }
       	  else{
       	  //如果当前元素在拖动目标位置的上方，先将当前元素从数组拿出，数组长度-1，我们直接给数组拖动目标位置+1的地方新增一个和当前元素值一样的元素，
       	  //这时，数组len不变，我们再把数组之前的那个拖动的元素删除掉，下标还是index
       	    arr.splice(tindex+1,0,arr[index]);
       	    arr.splice(index,1)
       	  }
       	  return arr;
       	}
       
       //教材树排序
       $("#bookCatelogSortTable tbody").sortable({
              handle: ".mdui-icon", //还有这个class类点中了才能拖移
              opacity: 0.6,                       //拖动时，透明度为0.6
              revert: true,
              axis:'y', // 只能y轴移动
              delay:100,// 按住100ms后才能使用，防止误触
              
            }).disableSelection();
       
       // ----------------------------------------排序结束---------------------------------
       
       
       function versionSortTableRowClick(baseVersion,index){
    	   vm.selectedSortVersionRow = Object.assign(vm.selectedSortVersionRow,baseVersion);
    	   vm.selectedSortVersionRow.selectedIndex = index;
    	   $(".versionSortTable tbody tr[class=mdui-table-row-selected]").removeClass("mdui-table-row-selected");
    	   $(".versionSortTable tbody tr[id="+index+"]").attr("class","mdui-table-row-selected");
       }
       
       
     //删除教材目录
       function deleteBookCateLogRow () {
    	   var inst = new mdui.Dialog('#dialogDeleteCatelog');
	    	if(vm.baseCatelogSelectedRow.kcId ===undefined|| vm.baseCatelogSelectedRow.kcId=='')
	    	{
	    		 mdui.alert("请勾选要操作的行！");
	    		 return false;
	    	}else{
	    	   inst.open();
	    	}
	   }
       
       //删除教材目录
       function deleteBookCateLog(){
    	   var obj = {};
  	       obj.kcId = vm.baseCatelogSelectedRow.kcId;
    	   $.ajax({
               type : "post",
               url : projectName + "/base/baseKnowledgeCatelog/delete",
               data : JSON.stringify(obj),
               datatype : 'json',
               contentType:"application/json",
               success : function(data) {
                   if(data.success == true){
                	  var index= vm.baseBookCateList.indexOf(vm.baseCatelogSelectedRow)
                	  if (index > -1) {
                		  vm.baseBookCateList.splice(index, 1);
                		}
                	  vm.baseBookCateSelectRowIndex=-1;
               	      vm.baseCatelogSelectedRow = {}; 
               	      updateTreeNode();
                   }else{
                       mdui.alert(data.message);
                   }
               },
               error : function() {
                   $.dialog.alert('请求失败！',function(){});
               }
           });
       }
       
       //添加教材弹出框
       function addOrEditBaseBookCatelog(add){
    	   var inst = new mdui.Dialog('#dialogAddBaseBookCatelog');
    	   if(add){
    	     vm.baseBookCateSelectRowIndex=-1;
    	     vm.baseCatelogSelectedRow = {};
    	     vm.baseCatelogSelectedRow.code='';
    	     vm.baseCatelogSelectedRow.name='';
      	     inst.open();
    	   }
    	   else{
	   	    	if(vm.baseCatelogSelectedRow.kcId ===undefined|| vm.baseCatelogSelectedRow.kcId=='')
	   	    	{
		    		 mdui.alert("请勾选要操作的行！");
		    		 return false;
	   	    	}else{
	   	    	 var nsel = mdui.Select('#nodeTypeSelect');
	   	    	 nsel.handleUpdate();
	   	    	 var ksel = mdui.Select('#knowTypeSelect');
	   	    	 ksel.handleUpdate();
	   	    	 inst.open();
	   	    	}
    	   }
       }
       
       //启用或者停用教材
       function stopOrStartBookCatelog(start){
    	   if(vm.baseCatelogSelectedRow.kcId ===undefined|| vm.baseCatelogSelectedRow.kcId=='')
  	    	{
	    		 mdui.alert("请勾选要操作的行！");
	    		 return false;
  	    	}else{
  	    		if(start){
  	    		   var inst = new mdui.Dialog('#dialogStartBookCatelog');
  	    		   inst.open();
  	    	   }else{
  	    		   var inst = new mdui.Dialog('#dialogStopBookCatelog');
  	    		   inst.open();
  	    	   }
  	    	}
       }
       
       //添加修改操作
       function operateSaveBaseBookCatelog(){
    	   var inst = new mdui.Dialog('#dialogAddBaseBookCatelog');
    	   if(vm.baseCatelogSelectedRow.kcId ===undefined|| vm.baseCatelogSelectedRow.kcId==''){
    		   addSaveBaseBookCatelog(); 
    	   }else{
    		   editBaseBookCatelog();
    	   } 
    	   inst.close();
       }
       
       //新增保存教材
       function addSaveBaseBookCatelog(){
    	   var obj = {};
    	   obj.parentCode = vm.checkedNode.code;
    	   obj.subjectCode = vm.baseSubject.propertyKey;
    	   obj.code = vm.baseCatelogSelectedRow.code;
  	       obj.name = vm.baseCatelogSelectedRow.name;
    	   obj.zhouCi = vm.baseCatelogSelectedRow.zhouCi;
  	       obj.nodeType = vm.baseCatelogSelectedRow.nodeType;
    	   $.ajax({
               type : "post",
               url : projectName + "/base/baseKnowledgeCatelog/save",
               data : JSON.stringify(obj),
               datatype : 'json',
               contentType:"application/json",
               success : function(data) {
                   if(data.success == true){
                	   mdui.alert("添加成功！");
                	   updateTreeNode();
                   }else{
                       mdui.alert(data.message);
                   }
               },
               error : function() {
                   $.dialog.alert('请求失败！',function(){});
               }
           });
       }
       //编辑保存教材
       function editBaseBookCatelog(){
    	   var obj = {};
    	   obj.kcId = vm.baseCatelogSelectedRow.kcId;
  	       obj.name = vm.baseCatelogSelectedRow.name;
  	       obj.zhouCi = vm.baseCatelogSelectedRow.zhouCi;
  	       obj.nodeType = vm.baseCatelogSelectedRow.nodeType;
    	   $.ajax({
               type : "post",
               url : projectName + "/base/baseKnowledgeCatelog/update",
               data : JSON.stringify(obj),
               datatype : 'json',
               contentType:"application/json",
               success : function(data) {
                   if(data.success == true){
                	   mdui.alert("保存成功！");
                	   updateTreeNode();
                   }else{
                       mdui.alert(data.message);
                   }
               },
               error : function() {
                   $.dialog.alert('请求失败！',function(){});
               }
           });
       }
       
       //保存停用或者启用教材
       function stopOrStartSaveBaseBookCatelog(status){
    	   
    	   var obj = {};
    	   obj.kcId = vm.baseCatelogSelectedRow.kcId;
  	       obj.status = status;
    	   $.ajax({
               type : "post",
               url : projectName + "/base/baseKnowledgeCatelog/update",
               data : JSON.stringify(obj),
               datatype : 'json',
               contentType:"application/json",
               success : function(data) {
                   if(data.success == true){
                	   var str = obj.status==0?'已启用':'已停用'
                       mdui.alert('['+vm.baseCatelogSelectedRow.name+'] '+str);
                	   vm.baseCatelogSelectedRow.status=obj.status;
                	   //var index= vm.baseBookCateList.indexOf(vm.baseCatelogSelectedRow)
                 	  //if (index > -1) {
                 		//  vm.baseBookCateList[index].;
                 		//}
                   }else{
                       mdui.alert(data.message);
                   }
               },
               error : function() {
                   $.dialog.alert('请求失败！',function(){});
               }
           });
       };
       
       //修改删除等操作后更新树状态
       function updateTreeNode(){
     	   var obj={};
     	   obj.subjectCode = vm.baseSubject.propertyKey;
     	   $.ajax({
                type : "post",
                url : projectName + "/base/baseKnowledgeCatelog/listTree",
                data : JSON.stringify(obj),
                datatype : 'json',
                contentType:"application/json",
                async: false,
                success : function(data) {
             	   if(data.success == true){
             		   zNodes = data.obj;
                        var treeObj =$.fn.zTree.init($("#treeDiv"), setting, zNodes);
                        var node = treeObj.getNodeByParam("code", vm.checkedNode.code);
                        treeObj.selectNode(node);
                        treeObj.setting.callback.onClick(null, treeObj.setting.treeId, node);
             	   }
                },
                error : function() {
                    $.dialog.alert('请求失败！',function(){});
                }
            });
        }
       

</script>

